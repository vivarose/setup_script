# bash script for encrypting and decrypting
# vibecoded with google gemini, 2025-12-17

# Custom function to OPEN 'secretfile'
opensecretfile() {
    if [ -f "secretfile" ]; then
        echo "File 'secretfile' is already unlocked. Opening in vim..."
        vim secretfile
    else
        # Decrypt
        if gpg -o secretfile -d secretfile.gpg; then
            echo "Unlocked successfully."
            
            # Take a fingerprint of the file state right now
            md5sum secretfile > ~/.secretfile.md5
            
            vim secretfile
        else
            echo "‚ö†Ô∏è Decryption failed or cancelled."
        fi
    fi
}

# Custom function to LOCK 'secretfile' safely
locksecretfile() {
    # 0. SAFETY CHECK: Ensure the plaintext file actually exists!
    if [ ! -f "secretfile" ]; then
        echo "üõë ABORTING: File 'secretfile' not found."
        return 1
    fi

    # 1. SMART CHECK: Did the file actually change?
    # We check if the checksum file exists, AND if the current file matches it.
    if [ -f ~/.secretfile.md5 ] && md5sum --status -c ~/.secretfile.md5; then
        echo "‚ÑπÔ∏è  File unchanged. Cleaning up without re-encrypting."
        
        # Verify the encrypted backup actually exists before we delete the plaintext!
        if [ ! -f "secretfile.gpg" ]; then
             echo "‚ö†Ô∏è WAIT! The encrypted file 'secretfile.gpg' is missing."
             echo "Forcing re-encryption to be safe..."
             # Fall through to encryption step below
        else
             # Securely remove plaintext and the temp checksum
             if [ -x "$(command -v shred)" ]; then shred -u secretfile; else rm secretfile; fi
             rm -f ~/.secretfile.md5
             echo "Closed."
             return 0
        fi
    fi

    # 2. Rotate backups (ignore errors if old backups don't exist yet)
    rm -f prevsecretfile2.gpg
    [ -f prevsecretfile.gpg ] && mv prevsecretfile.gpg prevsecretfile2.gpg
    [ -f secretfile.gpg ] && mv secretfile.gpg prevsecretfile.gpg

    # 3. Encrypt and verify
    echo "Encrypting with AES256..."
    if gpg -c --cipher-algo AES256 secretfile; then
        # Securely remove the original
        if [ -x "$(command -v shred)" ]; then shred -u secretfile; else rm secretfile; fi
        # Remove the old checksum file
        rm -f ~/.secretfile.md5
        echo "Locked and shredded."
    else
        echo "‚ö†Ô∏è ENCRYPTION FAILED. Original file kept safe."
        # Attempt to restore backup
        [ -f prevsecretfile.gpg ] && mv prevsecretfile.gpg secretfile.gpg
        echo "Restored previous backup to 'secretfile.gpg'."
    fi
}
